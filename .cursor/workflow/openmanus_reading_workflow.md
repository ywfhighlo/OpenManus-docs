# OpenManus 代码库走读工作流

## 工作流概述

本工作流描述了为**任意代码库**进行系统化走读分析的AI驱动流程。工作流采用结构化方式，由AI引导完成代码库的初始化扫描、构架分析、核心模块解读和文档生成。

## 核心原则

1. **原文尊重原则**
    * **绝对禁止** 修改任何源代码。
    * 保持原有的代码结构和组织方式。
    * 在分析前必须完整阅读代码。
    * 严格遵循项目的编码规范和风格。

2. **文档同步原则**
    * 分析文档必须与代码保持同步。
    * 重要发现必须及时记录和更新。
    * 图表必须反映最新的代码结构。
    * 确保文档的可追溯性和准确性。

3. **上下文管理原则**
    * 维护全局代码上下文。
    * 追踪代码依赖关系。
    * 记录分析历史状态。
    * 管理临时分析结果。
    * 保持上下文连贯性。

## 执行流程

### 阶段1：代码库初始化与结构生成

1. **项目扫描与结构生成**:
    * AI 首先创建输出目录：`mkdir -p output`
    * AI 执行预定义的命令或脚本（例如 `find . -type f -not -path "*/\.*" | sort > output/project_files.txt` 或 `python tools/generate_structure.py --output output/project_structure.json` 或 `tree -J -L 4 -o output/project_structure.json .`，具体命令需根据项目约定或用户指定）来扫描项目目录，生成包含文件列表的结构文件。
    * AI 确认结构文件已生成。
    * AI 根据项目结构建立分析计划。

2. **分析环境准备**:
    * 建立临时分析数据存储在output目录。
    * 初始化文档生成目录（output目录）。
    * 准备图表生成工具。
    * 配置日志记录系统。

### 阶段2：全面项目分析与架构理解

1. **读取结构**: AI 读取阶段 1 生成的结构文件（例如 `output/project_structure.json`）。
2. **识别关键文件**: AI 根据结构文件，结合通用启发式规则识别出需要进行深入分析的关键文件和目录：
   * 入口文件（如 `main.py`, `app.js`, `index.php` 等）
   * 配置文件（如 `config.yaml`, `settings.py` 等）
   * 核心模块目录（如 `src/`, `app/`, `core/` 等）
   * 基础类和接口文件（如包含 `base`, `interface`, `abstract` 关键字的文件）
   * 工具和辅助类（如 `utils/`, `helpers/` 等目录）
3. **系统性分析**: AI 依次读取识别出的关键文件，进行深入分析，理解：
   * 项目的主要目标和功能。
   * 核心组件/模块/类的职责和关键接口。
   * 主要的执行流程和数据流。
   * 关键的数据结构或模型定义。
   * 配置管理方式。
   * 主要的外部依赖及其用途。
   * 组件间的依赖关系。
4. **生成架构分析**: AI 将分析结果整理成一份结构化的 Markdown 文档（例如 `output/architecture_analysis.md`），包含系统概述、组件详解、流程说明等章节。该文件保存在工作区的output目录中。
5. **上下文准备**: AI 将分析指南的关键信息载入内存，作为后续走读工作的上下文参考。AI **直接进入下一阶段**，无需用户审核分析指南。

### 阶段3：迭代式代码走读

1. **分析计划生成**: AI 基于阶段 2 的架构分析，制定分为 5 天的代码走读计划：
   * **第1天**: 基础设施和通用组件分析
   * **第2天**: 核心模块和关键接口分析
   * **第3天**: 业务逻辑和流程控制分析
   * **第4天**: 外部接口和集成点分析
   * **第5天**: 测试覆盖和部署配置分析

2. **逐日走读执行**: 对每一天的计划，AI 执行以下子步骤：
   * **a. 读取目标文件**: 按照计划读取当天需要分析的文件。
   * **b. 代码分析**: 结合架构上下文，深入分析代码实现细节：
     * 类和函数的职责
     * 变量和参数的用途
     * 算法和实现逻辑
     * 错误处理机制
     * 性能考量点
   * **c. 文档生成**: 为当天的分析创建独立的 Markdown 文档（例如 `output/day1_analysis.md`），包含：
     * 概述和分析范围
     * 关键组件解析
     * 实现特点分析
     * 代码示例（带行号和文件路径）
     * Mermaid 图表（类图、序列图、流程图等）
     * 关键发现和建议
   * **d. 图表生成**: 为每个重要组件或流程创建可视化图表，保存在output/images目录中：
     * 类层次结构图
     * 组件交互时序图
     * 数据流程图
     * 状态转换图
   * **e. 分析总结**: 在每天的文档结尾提供当天分析的总结和下一步建议
   * **f. 状态更新**: 记录已完成的分析任务和待处理的任务项。

3. **持续分析验证**: 在整个走读过程中，AI 执行以下验证：
   * 确保分析覆盖了所有关键文件
   * 验证文档与代码的一致性
   * 检查图表的准确性和完整性
   * 评估分析深度是否符合要求

### 阶段4：总结与最终文档生成

1. **整体分析汇总**: 当 5 天的走读任务完成后，AI 生成一份综合分析报告保存为`output/final_report.md`：
   * 系统架构总结
   * 关键组件及其职责
   * 主要流程和数据流
   * 设计模式和实现特点
   * 潜在问题和改进建议
   * 代码质量评估

2. **导航文档生成**: AI 创建一个导航文档（`output/codereading_guide.md`），链接所有生成的分析文档和图表，便于整体浏览和查找特定内容。

3. **项目图谱生成**: 生成完整的项目结构和依赖关系图，保存在`output/images/project_structure.png`，提供对整个代码库的可视化概览。

4. **工作流执行报告**: 生成一份工作流执行报告保存为`output/execution_report.md`，包含：
   * 扫描的项目路径
   * 生成的结构文件名和分析指南文件名
   * 处理的文件总数和类型统计
   * 生成的文档和图表清单
   * 工作流执行的总时长（估算）
   * 未完全覆盖的区域（如有）

## 工作流使用说明

1. **启动工作流**:
   * 在编辑环境中输入指令："开始通用代码库走读工作流" (或类似指令)。
   * AI 将首先询问或确认用于生成项目结构文件的命令/脚本（例如 `tree -J -L 4 -o output/project_structure.json .` 或特定脚本）。
   * AI 开始执行阶段 1 的结构生成。

2. **监控过程**:
   * 观察 AI 的操作和工具输出，特别是阶段 2 生成的架构分析和阶段 3 的每日走读文档。
   * 用户可以在任何时候通过消息中断流程或提供指导。

3. **获取结果**:
   * 工作流完成后，AI 会提供阶段 4 的完成报告。
   * 用户可以在output目录找到生成的各类分析文档、图表和导航指南。

## 注意事项

1. **文件大小限制**
   * AI 工具可能对单次读取的文件大小有限制。对于非常大的文件，AI 应尝试分段读取和处理，但在添加注释前需确保理解了完整的上下文。
   * 生成结构文件时建议限制扫描深度（如 `tree -L 4`），避免生成过大的结构文件。

2. **代码走读深度**
   * 工作流默认按照5天计划进行走读，每天重点关注不同层面和模块。
   * 对于特别复杂的代码库，可能需要调整走读计划，但总体结构保持不变。

3. **状态维护**
   * AI 在对话上下文中维护当前走读进度和计划。
   * 支持中断后继续处理（可能需要重新执行分析阶段以恢复上下文）。

## 错误处理

1. **分析错误**
   * 如果 AI 在分析过程中遇到复杂或难以理解的代码，应记录并说明困难点。
   * 允许用户指令重试或提供额外上下文。
   * 保持其他文件的处理进度。

2. **工具调用错误** (如文件读取、结构生成失败)
   * 提供错误详情。
   * 建议可能的解决方案（如检查命令、文件权限）。
   * 等待用户确认或提供修正指令后继续。

## 工作流维护

1. **更新机制**
   * 根据实际使用情况调整阶段 2 分析的深度和广度。
   * 完善文档模板和图表生成规范。
   * 优化阶段 1 结构生成的推荐命令。

2. **反馈收集**
   * 鼓励用户在使用后提供反馈。
   * 记录遇到的问题和改进建议。
   * 持续优化工作流程。
