# OpenManus 代码库注释工作流

## 工作流概述

本工作流描述了为**任意Python代码库**添加中文注释的AI驱动流程。工作流采用交互式方式，由AI引导完成代码库的结构扫描、综合分析和注释添加。

## 核心原则

1. **不修改原则**
    * **绝对禁止** 修改任何源代码。
    * **绝对禁止** 修改、翻译或补充任何现有英文注释。
    * **绝对禁止** 翻译代码中的任何字符串字面量（例如错误信息、日志文本等）。
    * 保持原有的代码格式和缩进。

2. **增量注释原则**
    * **仅在完全没有注释的代码段** 添加 **中文** 注释。
    * 如果一个代码块或函数已有任何英文注释，则 **不得** 在该块或函数内添加任何新的中文注释。
    * 注释应该解释"为什么"而非"是什么"。

3. **注释深度与一致性**
    * **深度控制**：根据代码复杂度调整注释详细程度（复杂逻辑详述，简单代码简述）。
    * **一致性**：在整个代码库中保持术语、风格和格式的一致性。

4. **注释位置原则**
    * **绝对禁止** 添加任何行尾注释 (如 `code # comment`)。
    * **绝对禁止** 添加任何行内注释 (如 `code /* comment */ more_code`)。
    * 所有新添加的中文注释必须位于其描述的代码行的 **上方**，并独占一行或多行。

## 执行流程

### 阶段1：初始化与结构生成

1. **结构文件生成**:
    * AI 首先创建输出目录：`mkdir -p output`
    * AI 执行预定义的命令或脚本（例如 `Get-ChildItem -Recurse -Depth 4 | Select-Object FullName, Name, Length, LastWriteTime, @{Name='Type';Expression={if($_.PSIsContainer){'Directory'}else{'File'}}} | ConvertTo-Json -Depth 5 > output/project_structure.json` 或 `python tools/generate_structure.py --output output/project_structure.json` 或 `tree -J -L 4 -o output/project_structure.json .`，具体命令需根据项目约定或用户指定）来扫描项目目录，生成包含文件列表的结构文件（推荐JSON格式，限制扫描深度以避免过大文件）。
    * AI 确认结构文件已生成。

### 阶段2：全面项目分析与指南生成

1. **读取结构**: AI 读取阶段 1 生成的结构文件（例如 `output/project_structure.json`）。
2. **识别关键文件**: AI 根据结构文件，结合通用启发式规则（如查找 `main.py`, `setup.py`, `requirements.txt`, 核心子目录如 `src/`, `app/`, 包含 `base.py` 或 `__init__.py` 的目录）或用户指定的模式，识别出需要进行深入分析的关键文件和目录。
3. **系统性分析**: AI 依次读取识别出的关键文件（可能需要多次读取或交叉引用），进行深入分析，理解：
    * 项目的主要目标和功能。
    * 核心组件/模块/类的职责和关键接口。
    * 主要的执行流程和数据流。
    * 关键的数据结构或模型定义。
    * 配置管理方式。
    * 主要的外部依赖及其用途。
    * 组件间的依赖关系。
4. **生成分析指南**: AI 将分析结果整理成一份结构化的 Markdown 文档（例如 `output/project_analysis_guide.md`），包含概述、组件详解、流程说明等章节。该文件保存在output目录中。
5. **上下文准备**: AI 将分析指南的关键信息载入内存（或准备随时读取该文件），作为后续注释工作的上下文参考。AI **直接进入下一阶段**，无需用户审核分析指南。

### 阶段3：迭代注释

1. **任务队列**: AI 基于阶段 1 生成的结构文件，创建一个待处理的 Python 文件列表（`.py` 文件），按照它们在结构文件中的自然顺序排列。
2. **逐文件处理**: 对列表中的每个 `.py` 文件，执行以下子步骤：
    * **a. 读取文件**: `read_file(file_path, should_read_entire_file=True)` (或根据需要分段读取大文件，并确保处理前有完整上下文)。
    * **b. 上下文结合分析**: AI 结合阶段 2 生成的分析指南提供的全局上下文，以及当前文件的具体代码，分析代码逻辑。
    * **c. 识别注释点**: 检查文件内容，寻找**完全没有注释**的代码段（模块、类、主要函数/方法、复杂逻辑块、重要常量），并确认其所在的代码块/函数**没有任何**（包括英文）已有注释。遵循**粗粒度注释原则**。
    * **d. 生成注释**: 如果找到需要添加注释的代码段，AI 根据分析结果和注释规范生成相应的**中文**注释。
    * **e. 验证与编辑**: AI 仔细检查生成的注释和编辑计划：
        * **确认不违反核心原则**：注释位于代码上方、不修改任何已有代码或英文注释、不添加行内/行尾注释、不翻译字符串字面量。
        * **确认编辑操作的精确性**：编辑指令清晰，只包含新添加的注释和必要的 `// ... existing code ...` 标记（或对应语言的注释标记）。
    * **f. 添加注释**: 如果验证通过，AI 调用 `edit_file` 工具执行编辑操作。

        ```python
        # 示例调用
        edit_file(target_file=file_path,
                  instructions="添加中文注释，解释[模块/类/函数/代码块]的功能/目的...",
                  code_edit="[符合规范的注释和代码片段]")
        ```

    * **g. 状态更新**: 记录该文件已处理，并将信息记录到`output/comment_progress.json`。

### 阶段4：完成报告

1. **生成报告**: 当任务队列中的所有 Python 文件都处理完毕后，AI 生成一份工作流执行报告`output/comment_report.md`，包含：
    * 扫描的项目路径。
    * 生成的结构文件名和分析指南文件名。
    * 处理的 Python 文件总数。
    * 实际添加了注释的文件列表。
    * 因已有注释或其他原因跳过的文件列表（如有）。
    * 工作流执行的总时长（估算）。

## 注释规范

*所有注释必须遵循上述核心原则，特别是关于位置和不修改英文注释的规定。*

### 粗粒度注释原则

为了提高注释效率和可读性，避免过多冗余信息，采用以下粗粒度注释策略：

1. **模块/文件级别**: 在文件顶部添加注释，说明该模块的主要功能和目的。（参考下方文件头注释模板）
2. **类级别**: 为主要类添加注释，解释其职责和核心作用。对于 Pydantic 模型等定义清晰的类，若字段描述已足够，可省略或简化类注释。
3. **主要函数/方法级别**: 为重要的函数或方法（特别是逻辑复杂或承担核心功能的）添加注释，解释其 **目的、关键逻辑或实现思路**。避免解释显而易见的代码步骤。
4. **复杂逻辑块**: **仅**为函数内部特别复杂、难以直接理解、或包含重要设计决策的代码块添加注释。
5. **全局变量/常量**: 对重要的全局变量或常量添加注释，说明其用途。

### 注释模板示例

1. **文件头注释**

    ```python
    # 模块名称 (例如：用户认证模块)
    # 模块功能描述 (例如：处理用户登录、注册和会话管理)
    # 主要职责说明 (可选，更详细的描述)
    ```

2. **类注释**

    ```python
    # 类名称 (例如：用户服务类)
    # 类的主要职责 (例如：封装用户相关的业务逻辑)
    # 核心功能说明 (例如：提供创建、查找、更新用户的方法)
    # 使用示例（如适用）
    ```

3. **方法注释**

    ```python
    # 方法功能描述 (例如：根据用户ID查找用户信息)
    # 参数说明（如有，对复杂参数或关键参数）
    # 返回值说明（如有，对复杂返回值或关键返回值）
    # 异常说明（如有，抛出的主要异常类型和原因）
    ```

4. **变量注释**

    ```python
    # 变量用途说明 (例如：最大重试次数)
    # 取值范围（如适用）
    ```

5. **代码块注释**

    ```python
    # 代码块逻辑说明 (例如：处理支付回调的异步任务)
    # 实现步骤或原理 (例如：先验证签名，再更新订单状态...)
    # [相关代码块...]
    ```

## 工作流使用说明

1. **启动工作流**:
    * 在 Cursor 中输入指令："开始代码库注释工作流" (或类似指令)。
    * AI 将首先询问或确认用于生成项目结构文件的命令/脚本（例如 `tree -J -L 4 -o output/project_structure.json .` 或特定脚本）。请确保该命令在您的环境中可用。
    * AI 开始执行阶段 1 的结构生成。
2. **监控过程**:
    * 观察 AI 的操作和工具输出，特别是阶段 2 生成的分析指南 (`output/project_analysis_guide.md`) 和阶段 3 的注释添加过程。
    * 用户可以在任何时候通过消息中断流程或提供指导。
3. **获取结果**:
    * 工作流完成后，AI 会提供阶段 4 的完成报告。
    * 用户可以在output目录找到生成的 `project_analysis_guide.md` 和注释进度跟踪文件。

## 注意事项

1. **文件大小限制**
    * AI 工具可能对单次读取的文件大小有限制。对于非常大的文件，AI 应尝试分段读取和处理，但在添加注释前需确保理解了完整的上下文。
    * 生成结构文件时建议限制扫描深度（如 `tree -L 4`），避免生成过大的结构文件。
2. **非 Python 文件**
    * 当前工作流主要针对 `.py` 文件。对于其他类型的文件（如 `.yaml`, `.sh`, `.md`），AI 可以根据文件类型和内容尝试添加注释，但主要流程是围绕 Python 代码设计的。
3. **状态维护**
    * AI 在对话上下文中维护待处理文件列表和当前进度。
    * 支持中断后尝试继续处理（可能需要重新执行分析阶段以恢复上下文）。

## 错误处理

1. **注释生成/编辑错误**
    * 如果 AI 添加注释的操作失败或产生不符合预期的结果，应记录错误原因。
    * 允许用户指令重试或跳过该文件的处理。
    * 保持其他文件的处理进度。
2. **工具调用错误** (如文件读取、结构生成失败)
    * 提供错误详情。
    * 建议可能的解决方案（如检查命令、文件权限）。
    * 等待用户确认或提供修正指令后继续。

## 工作流维护

1. **更新机制**
    * 根据实际使用情况调整阶段 2 分析的深度和广度。
    * 完善注释模板和粗粒度注释原则。
    * 优化阶段 1 结构生成的推荐命令。
2. **反馈收集**
    * 鼓励用户在使用后提供反馈。
    * 记录遇到的问题和改进建议。
    * 持续优化工作流程。
